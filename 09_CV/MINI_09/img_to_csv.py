import os
import cv2

def preprocess_images_to_csv(DATA_DIR, CSV_DIR, filename, fruite_name):
    """
    이미지 디렉토리의 파일들을 전처리하여 CSV 파일로 저장하는 함수

    - DATA_DIR   : 전처리할 이미지들이 들어있는 폴더 경로
    - CSV_DIR    : CSV 파일을 저장할 폴더 경로
    - filename   : 저장할 CSV 파일 이름 (확장자 제외)
    - fruite_name: 각 이미지에 부여할 라벨 값 (예: 'apple', 'banana')
    """

    # ------------------------------------------------------
    # 1. 이미지가 들어있는 디렉토리에서 파일 목록 가져오기
    # ------------------------------------------------------
    file_list = os.listdir(DATA_DIR)

    # ------------------------------------------------------
    # 2. CSV 저장용 디렉토리 생성
    #    - 디렉토리가 없으면 새로 생성
    #    - 이미 존재하면 그대로 사용
    # ------------------------------------------------------
    if not os.path.exists(CSV_DIR):
        os.mkdir(CSV_DIR)
    else:
        print(f'{CSV_DIR} : 이미 존재합니다.')

    # ------------------------------------------------------
    # 3. 저장할 CSV 파일 경로 생성
    #    예) CSV_DIR='./Data/csv', filename='fruit'
    #        → './Data/csv/fruit.csv'
    # ------------------------------------------------------
    csv_path = os.path.join(CSV_DIR, f'{filename}.csv')

    # ------------------------------------------------------
    # 4. CSV 파일 열기 (append 모드)
    #    - 파일이 없으면 새로 생성
    #    - 파일이 있으면 기존 내용 뒤에 이어서 작성
    # ------------------------------------------------------
    with open(csv_path, mode='a', encoding='utf-8') as F:
        for file_name in file_list:
            # 개별 이미지 파일 경로 생성
            img_path = f'{DATA_DIR}/{file_name}'

            # --------------------------------------------------
            # 5. 이미지 로드 + 그레이스케일 변환 + 축소
            #    - INTER_AREA: 이미지 축소에 적합
            # --------------------------------------------------
            img = cv2.resize(
                cv2.imread(img_path, cv2.IMREAD_GRAYSCALE),
                (0, 0),
                fx=0.5, fy=0.5,
                interpolation=cv2.INTER_AREA
            )

            # --------------------------------------------------
            # 6. 모델 입력을 위한 고정 크기 리사이즈 (70x70)
            # --------------------------------------------------
            img = cv2.resize(
                img,
                (70, 70),
                interpolation=cv2.INTER_AREA
            )

            # --------------------------------------------------
            # 7. 2차원 이미지를 1차원 벡터로 변환
            #    (한 이미지 = 한 행)
            # --------------------------------------------------
            img = img.reshape(-1)

            # --------------------------------------------------
            # 8. CSV 한 줄(row) 생성
            #    형식: label,pixel1,pixel2,...
            # --------------------------------------------------
            raw = [str(i) for i in img.tolist()]
            raw = ','.join(raw)
            F.write(fruite_name + ',' + raw + '\n')
